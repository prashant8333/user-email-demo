{% extends "base.html" %}

{% block head_extra %}
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="glass-panel animate-fade-in" style="padding: 2rem; max-width: 900px; margin: 0 auto;">
    <h1>Create Campaign</h1>

    <form id="campaign-form" method="POST" action="{{ url_for('main.create_campaign') }}" enctype="multipart/form-data">
        <!-- Step 1: List Upload -->
        <div style="margin-bottom: 3rem;">
            <h3 style="margin-bottom: 1rem; color: var(--primary);">1. Recipients</h3>

            <div id="drop-zone" class="upload-zone">
                <i class="fa-solid fa-cloud-arrow-up"
                    style="font-size: 2rem; margin-bottom: 1rem; color: var(--text-muted);"></i>
                <p>Drag & Drop your CSV/Excel file here</p>
                <p style="font-size: 0.8rem; color: var(--text-muted); margin: 0.5rem 0;">or</p>
                <button type="button" class="btn btn-secondary"
                    onclick="document.getElementById('file-input').click()">Browse Files</button>
                <input type="file" id="file-input" name="recipient_file" accept=".csv, .xlsx" style="display: none;"
                    onchange="handleFileSelect(this)">
                <div id="file-info"
                    style="display: none; margin-top: 1rem; align-items: center; justify-content: center; gap: 1rem; background: rgba(0,0,0,0.03); padding: 0.5rem 1rem; border-radius: 8px; border: 1px solid var(--border);">
                    <span id="file-name-text" style="font-weight: 600; color: var(--primary);"></span>
                    <button type="button" onclick="clearFileSelection()"
                        style="background: none; border: none; color: var(--danger); cursor: pointer; font-size: 1.2rem; display: flex; align-items: center;"
                        title="Remove file">
                        <i class="fa-solid fa-trash-can"></i>
                    </button>
                </div>
            </div>
            <div style="margin-top: 2rem;">
                <label for="manual_emails"
                    style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text);">Enter email
                    addresses manually</label>
                <textarea id="manual_emails" name="manual_emails"
                    placeholder="Type or paste email addresses here (separated by commas or new lines)"
                    style="width: 100%; min-height: 120px; padding: 1rem; border: 2px solid var(--border); border-radius: 8px; font-family: inherit; font-size: 0.95rem; resize: vertical; background: white; transition: border-color 0.2s;"
                    onfocus="this.style.borderColor='var(--primary)'"
                    onblur="this.style.borderColor='var(--border)'"></textarea>
            </div>

            <!-- Column Selection Area -->
            <div id="column-selection" style="margin-top: 1rem; display: none;">
                <h4>Map Columns</h4>

                <!-- CSV Select Mode -->
                <div id="csv-mode" style="display: none;">
                    <p style="font-size: 0.9rem; color: var(--text-muted);">Enter the exact name of the column
                        containing emails:</p>
                    <input type="text" name="email_column_select" id="email-column-select"
                        placeholder="e.g. email or Email"
                        style="margin-top: 0.5rem; padding: 0.5rem; border: 1px solid var(--border); border-radius: 4px; width: 100%; max-width: 300px;">

                    <p style="font-size: 0.9rem; color: var(--text-muted); margin-top: 1rem;">
                        <strong>Optional:</strong> Enter column names for name and birthday data:
                    </p>
                    <div style="display: flex; gap: 1rem; margin-top: 0.5rem; flex-wrap: wrap;">
                        <div style="flex: 1; min-width: 250px;">
                            <label for="name-column-select" style="font-size: 0.85rem; color: var(--text-muted);">Name
                                Column (Optional)</label>
                            <input type="text" name="name_column_select" id="name-column-select"
                                placeholder="e.g. name or Full Name"
                                style="margin-top: 0.25rem; padding: 0.5rem; border: 1px solid var(--border); border-radius: 4px; width: 100%;">
                        </div>
                        <div style="flex: 1; min-width: 250px;">
                            <label for="dob-column-select" style="font-size: 0.85rem; color: var(--text-muted);">Date of
                                Birth Column (Optional)</label>
                            <input type="text" name="dob_column_select" id="dob-column-select"
                                placeholder="e.g. dob or Birthday"
                                style="margin-top: 0.25rem; padding: 0.5rem; border: 1px solid var(--border); border-radius: 4px; width: 100%;">
                        </div>
                    </div>

                    <div
                        style="overflow-x: auto; margin-top: 1rem; border: 1px solid var(--border); border-radius: 8px;">
                        <table id="preview-table" style="width: 100%; border-collapse: collapse; font-size: 0.8rem;">
                            <!-- Populated by JS -->
                        </table>
                    </div>
                </div>

                <!-- Excel/Manual Mode -->
                <div id="excel-mode" style="display: none;">
                    <p style="font-size: 0.9rem; color: var(--text-muted);">
                        Preview is not available for Excel files. Please enter the exact name of the column containing
                        emails:
                    </p>
                    <input type="text" name="email_column_text" id="email-column-text" placeholder="e.g. Email"
                        style="margin-top: 0.5rem; padding: 0.5rem; border: 1px solid var(--border); border-radius: 4px; width: 100%; max-width: 300px;">

                    <p style="font-size: 0.9rem; color: var(--text-muted); margin-top: 1rem;">
                        <strong>Optional:</strong> Enter column names for name and birthday data:
                    </p>
                    <div style="display: flex; gap: 1rem; margin-top: 0.5rem; flex-wrap: wrap;">
                        <div style="flex: 1; min-width: 250px;">
                            <label for="name-column-text" style="font-size: 0.85rem; color: var(--text-muted);">Name
                                Column (Optional)</label>
                            <input type="text" name="name_column_text" id="name-column-text"
                                placeholder="e.g. Name or Full Name"
                                style="margin-top: 0.25rem; padding: 0.5rem; border: 1px solid var(--border); border-radius: 4px; width: 100%;">
                        </div>
                        <div style="flex: 1; min-width: 250px;">
                            <label for="dob-column-text" style="font-size: 0.85rem; color: var(--text-muted);">Date of
                                Birth Column (Optional)</label>
                            <input type="text" name="dob_column_text" id="dob-column-text"
                                placeholder="e.g. DOB or Birthday"
                                style="margin-top: 0.25rem; padding: 0.5rem; border: 1px solid var(--border); border-radius: 4px; width: 100%;">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 2: Message Composition -->
        <div style="margin-bottom: 3rem;">
            <h3 style="margin-bottom: 1rem; color: var(--primary);">2. Message</h3>

            <div class="form-group">
                <label for="campaign_name">Campaign Name (Internal)</label>
                <input type="text" id="campaign_name" name="campaign_name" required
                    placeholder="e.g. December Newsletter">
            </div>

            <div class="form-group">
                <label for="subject">Subject Line</label>
                <input type="text" id="subject" name="subject" required placeholder="e.g. Special Offer Just for You!">
            </div>

            <div class="form-group">
                <label>Message Body</label>
                <div
                    style="background: white; color: black; border-radius: 8px; overflow: hidden; border: 2px solid #94a3b8;">
                    <div id="editor" style="height: 300px;"></div>
                </div>
                <input type="hidden" name="body_content" id="body_content">
            </div>

            <div class="form-group">
                <button type="button" class="btn btn-secondary" style="font-size: 0.9rem;"
                    onclick="insertTrackingLink()">
                    <i class="fa-solid fa-link" style="margin-right: 0.5rem;"></i> Insert Verification Link Button
                </button>
                <p style="font-size: 0.8rem; color: var(--text-muted); margin-top: 0.5rem;">
                    This inserts a button that will be tracked when clicked.
                </p>
            </div>

            <div class="form-group">
                <label for="scheduled_at">Schedule Send Time (Optional)</label>
                <input type="datetime-local" id="scheduled_at" name="scheduled_at"
                    placeholder="Leave empty to send immediately">
                <p style="font-size: 0.8rem; color: var(--text-muted); margin-top: 0.5rem;">
                    Leave empty to send immediately when you start the campaign, or pick a future date/time to schedule
                    it.
                </p>
            </div>
        </div>

        <!-- Step 3: Sending Configuration -->
        <div style="margin-bottom: 3rem;">
            <h3 style="margin-bottom: 1rem; color: var(--primary);">3. Sending Configuration</h3>

            <div style="display: flex; gap: 2rem; flex-wrap: wrap;">
                <div class="form-group" style="flex: 1; min-width: 250px;">
                    <label for="batch_size">Batch Size (Emails per batch)</label>
                    <input type="number" id="batch_size" name="batch_size" value="50" min="1" required
                        placeholder="e.g. 50">
                    <p style="font-size: 0.8rem; color: var(--text-muted); margin-top: 0.5rem;">
                        Number of emails to send before pausing.
                    </p>
                </div>

                <div class="form-group" style="flex: 1; min-width: 250px;">
                    <label for="batch_delay">Batch Delay (Minutes)</label>
                    <input type="number" id="batch_delay" name="batch_delay" value="5" min="0" required
                        placeholder="e.g. 5">
                    <p style="font-size: 0.8rem; color: var(--text-muted); margin-top: 0.5rem;">
                        Wait time between batches in minutes.
                    </p>
                </div>
            </div>
        </div>

        <!-- Actions -->
        <div
            style="display: flex; justify-content: flex-end; gap: 1rem; padding-top: 2rem; border-top: 1px solid var(--border);">
            <a href="{{ url_for('main.dashboard') }}" class="btn btn-secondary">Cancel</a>
            <button type="submit" class="btn btn-primary" onclick="prepareForm()">Review Campaign</button>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
<script>
    // Initialize Quill
    var quill = new Quill('#editor', {
        theme: 'snow',
        placeholder: 'Compose your message...',
        modules: {
            toolbar: [
                ['bold', 'italic', 'underline', 'strike'],
                [{ 'list': 'ordered' }, { 'list': 'bullet' }],
                [{ 'header': [1, 2, 3, false] }],
                ['link', 'clean']
            ]
        }
    });

    function insertTrackingLink() {
        const range = quill.getSelection(true);
        if (range) {
            // Insert the placeholder text that will be replaced on backend
            quill.insertText(range.index, '[VERIFY_BUTTON]');
            quill.formatText(range.index, '[VERIFY_BUTTON]'.length, 'bold', true);
        } else {
            // If no selection, insert at the end
            const length = quill.getLength();
            quill.insertText(length - 1, '[VERIFY_BUTTON]');
            quill.formatText(length - 1, '[VERIFY_BUTTON]'.length, 'bold', true);
        }
    }

    function prepareForm() {
        // Put HTML into hidden input
        document.querySelector('#body_content').value = quill.root.innerHTML;
        // Don't convert timezone - keep local time as-is
    }
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
{% endblock %}